import numpy as np
from ase.collections import g2
from gpaw import GPAW, LCAO
from ase.parallel import paropen
import time
from gpaw.directmin.etdm import ETDM

xc = 'PBE'
mode = LCAO()

with paropen('dm-g2-results.txt', 'w') as fd:
    for name in g2.names:
        atoms = g2[name]
        if len(atoms) == 1:
            continue
        atoms.center(vacuum=7.0)
        calc = GPAW(xc=xc, h=0.15,
                    convergence={'density': 1.0e-6},
                    basis='dzp',
                    mode=mode,
                    txt=name + '.txt',
                    eigensolver=ETDM(matrix_exp='egdecomp-u-invar',
                                     representation='u-invar'),
                    mixer={'backend': 'no-mixing'},
                    nbands='nao',
                    occupations={'name': 'fixed-uniform'},
                    symmetry='off'
                    )
        atoms.calc = calc

        t1 = time.time()
        e = atoms.get_potential_energy()
        t2 = time.time()
        steps = atoms.calc.get_number_of_iterations()
        iters = atoms.calc.wfs.eigensolver.eg_count
        print(name + "\t{}".format(iters),
              file=fd, flush=True)

output = \
    """
PH3	9	10	-15.067594250491323	6.6201441287994385	341.027
P2	6	8	-8.379318635747365	5.050562620162964	341.027
CH3CHO	14	17	-37.75204876792297	13.296800136566162	394.836
H2COH	12	16	-23.69898686685713	15.289788722991943	464.316
CS	10	13	-9.417455952101529	6.885095119476318	464.316
OCHCHO	11	15	-35.666514372774785	10.376455307006836	464.316
C3H9C	13	15	-66.59136951997174	20.99063277244568	563.824
CH3COF	13	16	-38.4905594550757	11.511932134628296	563.824
CH3CH2OCH3	12	14	-61.30296354126676	13.773707389831543	563.824
HCOOH	13	16	-28.408002357246865	10.584598779678345	563.824
HCCl3	11	14	-17.40322721170416	11.346881628036499	563.824
HOCl	12	19	-9.763721177128842	10.576534271240234	563.824
H2	5	6	-6.490747304345913	3.601301670074463	563.824
SH2	8	10	-10.506039275136805	6.224019527435303	563.824
C2H2	8	10	-21.831120179124515	6.191981315612793	563.824
C4H4NH	12	15	-60.36706614168592	12.437836170196533	563.824
CH3SCH3	11	13	-42.75640371331927	11.147183179855347	563.824
SiH2_s3B1d	10	11	-8.439696476805787	11.634494543075562	563.824
CH3SH	10	12	-26.575973842997186	9.456661701202393	563.824
CH3CO	13	17	-32.72729035439991	19.116678476333618	563.824
CO	9	11	-13.815908836466543	5.7934653759002686	563.824
ClF3	15	18	-7.279906905738146	11.506683826446533	563.824
SiH4	8	9	-18.407226340441163	6.766280651092529	563.824
C2H6CHOH	12	15	-61.72625777640576	12.839509963989258	563.824
CH2NHCH2	12	15	-42.17124083425262	11.608701229095459	563.824
isobutene	13	16	-63.67223781609167	14.94152045249939	563.824
HCO	13	20	-16.124831216748227	17.845112562179565	563.824
bicyclobutane	12	14	-54.503393011455486	13.057802677154541	563.824
LiF	12	14	-5.817805188634345	7.1125805377960205	563.824
C2H6	10	12	-39.5282496643079	9.23299789428711	563.824
CN	15	18	-12.014894676426977	14.159236907958984	563.824
ClNO	16	20	-13.63804219450336	11.944746017456055	563.824
SiF4	9	11	-25.20937860100401	7.946461200714111	563.824
H3CNH2	12	14	-34.54290009661039	10.162980556488037	563.824
methylenecyclopropane	12	15	-54.6879018075723	12.656071662902832	563.824
CH3CH2OH	12	15	-45.38183883038578	10.822251081466675	563.824
NaCl	13	15	-3.9915002448726358	8.350746154785156	563.824
CH3Cl	11	13	-21.364341391719453	9.6176438331604	563.824
CH3SiH3	10	12	-34.95738850941009	10.10890507698059	563.824
AlF3	9	12	-18.708233835513557	7.2954466342926025	563.824
C2H3	12	15	-24.91262778147432	15.6882905960083	563.824
ClF	10	13	-3.083951458122166	6.864815711975098	563.824
PF3	10	14	-17.6200414942034	10.0963613986969	563.824
PH2	10	11	-10.333093382175694	11.305602073669434	563.824
CH3CN	13	16	-35.40005851345955	11.683635473251343	563.824
cyclobutene	11	13	-55.09356789335748	10.821738481521606	563.824
CH3ONO	15	18	-37.48477835032511	11.76747465133667	563.824
SiH3	10	11	-13.414712732958558	12.719384670257568	563.824
C3H6_D3h	10	12	-47.16406379242271	8.487723350524902	563.824
CO2	8	10	-21.686869966483524	5.838723659515381	563.824
NO	39	47	-11.327631125222853	33.597381353378296	563.824
trans-butane	11	13	-71.89450752855547	12.830519676208496	563.824
H2CCHCl	12	15	-29.238625168100576	10.552400350570679	563.824
LiH	10	11	-3.531257198110949	5.818307638168335	563.824
NH2	11	13	-12.766498080792353	11.73012638092041	563.824
CH	34	38	-5.674378327614047	27.39079523086548	563.824
CH2OCH2	12	15	-36.76143971942084	11.153969526290894	563.824
C6H6	10	12	-73.85217535506382	11.361202239990234	563.824
CH3CONH2	15	18	-50.16888351727816	13.662843227386475	563.824
cyclobutane	10	12	-63.53872939601613	12.189512252807617	563.824
H2CCHCN	14	18	-43.162802485831776	13.73363208770752	563.824
butadiene	12	14	-55.3102844458418	11.70579743385315	563.824
H2CO	11	14	-21.136756510681643	8.287042617797852	563.824
CH3COOH	14	17	-44.92291892250132	12.282413482666016	563.824
HCF3	10	14	-23.33193072036996	8.672154188156128	563.824
CH3S	11	13	-21.690397937558533	15.602460384368896	576.680
CS2	8	11	-15.408202617521624	6.814993619918823	576.680
SiH2_s1A1d	9	10	-9.141455540051073	6.267746448516846	576.680
C4H4S	13	16	-52.33896491532939	13.166259050369263	576.680
N2H4	11	14	-29.04826077564009	9.470504999160767	576.680
OH	23	27	-6.982508936175612	20.008042097091675	576.680
CH3OCH3	12	16	-44.99441429004591	12.613993406295776	576.680
C5H5N	13	16	-69.10577872701126	14.067912817001343	576.680
H2O	9	12	-13.248879020254805	6.589300632476807	576.680
HCl	7	9	-5.362280651746735	4.954823017120361	576.680
CH2_s1A1d	9	11	-10.757688251327073	6.483432054519653	576.680
CH3CH2SH	12	15	-42.77182919987737	10.960923194885254	576.680
CH3NO2	13	16	-37.59598912842743	11.989314079284668	576.680
BCl3	9	12	-14.568120361655941	8.877570867538452	576.680
C4H4O	13	16	-54.632472747679074	12.315144300460815	576.680
CH3O	12	14	-23.459267720379835	15.61195707321167	576.680
CH3OH	11	14	-29.060866334893923	10.651534795761108	576.680
C3H7Cl	12	15	-53.83123625718132	11.591075897216797	576.680
isobutane	11	13	-71.94266082590747	12.21088194847107	576.680
CCl4	10	12	-15.275852686988774	9.668414115905762	576.680
CH3CH2O	14	16	-39.641252099285346	18.87748694419861	610.016
H2CCHF	12	15	-30.904670428100868	9.352671384811401	610.016
C3H7	13	15	-50.22805517183567	21.300893306732178	628.715
CH3	9	11	-17.49384850623045	11.260732889175415	628.715
O3	13	16	-12.433529583245473	8.492688417434692	628.715
C2H4	9	11	-30.958765485095768	7.16547417640686	628.715
NCCN	10	12	-30.658037813517044	7.438244104385376	628.715
S2	7	8	-6.219282082506314	8.06432032585144	628.715
AlCl3	10	13	-12.98573282335161	10.286387205123901	628.715
SiCl4	10	13	-16.78447293181344	10.305726766586304	628.715
SiO	13	15	-10.262784811760204	7.762621164321899	628.715
C3H4_D2d	11	15	-38.56777011081724	11.63664722442627	628.715
COF2	12	15	-22.14128628537746	9.729094505310059	628.715
2-butyne	11	14	-54.939470685326455	12.09960150718689	628.715
C2H5	12	14	-33.8500443324274	16.278650760650635	628.715
BF3	8	11	-21.572371839064136	7.56982946395874	628.715
N2O	11	14	-20.102195376334976	7.538554906845093	628.715
F2O	11	15	-7.399576680971737	8.561578273773193	628.715
SO2	11	13	-14.870794217160935	8.06005311012268	628.715
H2CCl2	11	14	-19.399637762862064	10.493011474609375	628.715
CF3CN	13	16	-34.906808720109986	12.747795343399048	628.715
HCN	10	14	-18.73012010449129	7.592958927154541	628.715
C2H6NH	13	15	-50.52630869093685	12.557099342346191	628.715
OCS	10	14	-18.601453536910835	8.144315958023071	628.715
ClO	43	52	-4.6936828818312275	38.79070472717285	628.715
C3H8	11	13	-55.717607762841126	11.495843172073364	628.715
HF	9	11	-7.0029471215133015	5.6659557819366455	628.715
O2	7	8	-9.108226430211426	7.30400824546814	628.715
SO	11	14	-7.920249959323364	12.075945138931274	628.715
NH	9	11	-7.489024231960305	9.350391864776611	628.715
C2F4	10	13	-30.24116221475319	8.929929256439209	628.715
NF3	11	15	-14.064869244897391	8.2968111038208	628.715
CH2_s3B1d	10	12	-11.464140729402992	11.385049104690552	628.715
CH3CH2Cl	12	15	-37.64619843915724	10.208197116851807	628.715
CH3COCl	14	18	-36.57929939296139	14.233556032180786	628.715
NH3	10	12	-18.687024847371475	7.675932168960571	628.715
C3H9N	13	15	-66.57679757132048	12.152807474136353	628.715
CF4	9	12	-23.61462611454026	8.489920377731323	628.715
C3H6_Cs	12	15	-47.320065716714126	11.012365102767944	628.715
Si2H6	9	10	-30.15440392023656	9.363189935684204	628.715
HCOOCH3	13	16	-44.2664512112896	11.696305990219116	628.715
CCH	12	16	-14.799136984583923	13.88939094543457	628.715
Si2	8	9	-4.793225261681442	8.916304588317871	628.715
C2H6SO	14	17	-48.02622324542428	13.68994927406311	628.715
C5H8	11	13	-70.91759596894674	12.48584794998169	628.715
H2CF2	10	13	-22.97018289970631	9.399551391601562	628.715
Li2	6	7	-1.3181686820255385	4.5403852462768555	628.715
CH2SCH2	11	13	-34.71535928912935	10.46346664428711	628.715
C2Cl4	11	14	-23.59447986714585	10.373555183410645	628.715
C3H4_C3v	13	16	-38.41646304753126	12.374937534332275	628.715
CH3COCH3	12	19	-54.26543917872743	15.8279550075531	628.715
F2	7	9	-2.7777443960323573	5.0293965339660645	628.715
CH4	8	11	-23.399963889551103	6.719749450683594	628.715
SH	38	41	-5.401168291262951	31.133654356002808	628.715
H2CCO	12	15	-29.572163404216557	9.68120527267456	628.715
CH3CH2NH2	12	14	-50.82292789668282	10.029752969741821	628.715
N2	7	8	-15.608612050282868	4.470391273498535	628.715
Cl2	7	9	-2.535359129835213	5.291595697402954	628.715
H2O2	11	14	-16.95818938312642	8.642603874206543	628.715
Na2	9	10	-1.064315921432062	6.466836214065552	628.715
BeH	9	10	-2.9158725067581828	8.906505346298218	628.715
C3H4_C2v	11	14	-37.68429215491533	11.209607362747192	628.715
NO2	12	15	-17.169478949870694	13.804738521575928	628.715
"""

output.splitlines()

# this is saved data
saved_data = {}
for i in output.splitlines():
    if i == '':
        continue
    mol = i.split()
    # ignore last two columns which are memory and elapsed time
    saved_data[mol[0]] = np.array([float(_) for _ in mol[1:-2]])

file2read = open('dm-g2-results.txt', 'r')
calculated_data_string = file2read.read().split('\n')
file2read.close()

# this is data calculated, we would like to coompare it to saved
# compare number of iteration, energy and gradient evaluation,
# and energy

calculated_data = {}
for i in calculated_data_string:
    if i == '':
        continue
    mol = i.split()
    # ignore last two columns which are memory and elapsed time
    calculated_data[mol[0]] = np.array([float(_) for _ in mol[1:-2]])

error = np.array([3, 3, 1.0e-3])

assert len(calculated_data) == len(saved_data)
for k in saved_data.keys():
    assert (abs(saved_data[k] - calculated_data[k]) < error).all()
