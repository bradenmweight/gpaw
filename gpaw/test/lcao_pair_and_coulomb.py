import numpy as np
import cPickle as pickle
from ase.data.molecules import molecule
from gpaw.lcao.tools import makeU, makeV
from gpaw import GPAW, FermiDirac, restart
from gpaw.lcao.pwf2 import LCAOwrap
from gpaw.lcao.tools import remove_pbc, get_bfi2, get_bf_centers
from gpaw.mpi import world, rank, MASTER, serial_comm
from gpaw.test import equal
import os
os.system('gpaw-basis -t dz -E 0.1 H > tmp.txt')
scat = range(2)
atoms = molecule('H2')
atoms.set_cell([8., 8., 8.])
atoms.center()
basis='dz'
calc = GPAW(mode='lcao', occupations=FermiDirac(0.1), basis=basis)
atoms.set_calculator(calc)
atoms.get_potential_energy()
calc.write('lcao_pair.gpw')

if rank == MASTER:
    atoms, calc = restart('lcao_pair.gpw',
                          txt=None, communicator=serial_comm)
    lcao = LCAOwrap(calc)
    fermi = calc.get_fermi_level()
    #print >> open('fermi_scat.txt', 'w'), repr(fermi)
    H = lcao.get_hamiltonian()
    S = lcao.get_overlap()
    pickle.dump((H, S), open('lcao_pair_hs.pckl', 'wb'), 2)
    symbols = atoms.get_chemical_symbols()
    indices = get_bfi2(symbols, basis, scat)
    lcao.get_xc(indices=indices).dump('lcao_pair_xc.pckl')
    lcao.get_Fcore(indices=indices).dump('lcao_pair_Fcore.pckl')
    w_wG = lcao.get_orbitals(indices=indices)
    P_awi = lcao.get_projections(indices=indices)
    pickle.dump((w_wG, P_awi), open('lcao_pair_w_wG__P_awi.pckl', 'wb'), 2)

makeU('lcao_pair.gpw',
      'lcao_pair_w_wG__P_awi.pckl',
      'lcao_pair_eps_q__U_pq.pckl',
      1.0e-5,
      dppname='lcao_pair_D_pp.pckl')

makeV('lcao_pair.gpw',
      'lcao_pair_w_wG__P_awi.pckl',
      'lcao_pair_eps_q__U_pq.pckl',
      'lcao_pair_V_qq.pckl',
      'lcao_pair_V_qq.log',
      False)

V_qq = np.load('lcao_pair_V_qq.pckl')
eps_q, U_pq = np.load('lcao_pair_eps_q__U_pq.pckl')
assert U_pq.flags.contiguous
Usq_pq = U_pq * np.sqrt(eps_q)

V_pp = np.dot(np.dot(Usq_pq, V_qq), Usq_pq.T.conj())
V_pp_ref = np.fromstring('1.635962689223832101e+01 1.119799862790637413e+01 1.156041325087445237e+01 6.899529365494869282e+00 1.119799862790685197e+01 8.293439740376605585e+00 7.244102014665478428e+00 4.658396331026996684e+00 1.156041325087438132e+01 7.244102014665432243e+00 1.346174795969930038e+01 8.897497307897769048e+00 6.899529365494875499e+00 4.658396331026988690e+00 8.897497307897765495e+00 6.470106628633408796e+00 1.119799862790637413e+01 7.760914578593552271e+00 7.786684374145478316e+00 4.686010172387336858e+00 7.760914578593845370e+00 5.788141526474977816e+00 4.954674957944496860e+00 3.197300671294213803e+00 7.786684374145433907e+00 4.954674957944468439e+00 8.897497310362632916e+00 5.919309415106647876e+00 4.686010172387341299e+00 3.197300671294208918e+00 5.919309415106644323e+00 4.316359790351772752e+00 1.156041325087444882e+01 7.786684374145477427e+00 9.000410925657718053e+00 5.515035848943385055e+00 7.786684374145838916e+00 5.717017114640454700e+00 5.515035849905880916e+00 3.639539647180053183e+00 9.000410925657662986e+00 5.515035849905845389e+00 1.156041324186114316e+01 7.786684366646839273e+00 5.515035848943392160e+00 3.639539647180046078e+00 7.786684366646834832e+00 5.717017108424189864e+00 6.899529365494868394e+00 4.686010172387335082e+00 5.515035848943385055e+00 3.451471152955653654e+00 4.686010172387533146e+00 3.456341064866929713e+00 3.408949038855442648e+00 2.284490630041605463e+00 5.515035848943355745e+00 3.408949038855424440e+00 7.244102008426491324e+00 4.954674953017853767e+00 3.451471152955656763e+00 2.284490630041601911e+00 4.954674953017851102e+00 3.665412685628683942e+00 1.119799862790685019e+01 7.760914578593841817e+00 7.786684374145838028e+00 4.686010172387531370e+00 7.760914578594136692e+00 5.788141526475182985e+00 4.954674957944694924e+00 3.197300671294336372e+00 7.786684374145793619e+00 4.954674957944665614e+00 8.897497310363085887e+00 5.919309415106926764e+00 4.686010172387535810e+00 3.197300671294331487e+00 5.919309415106923211e+00 4.316359790351970815e+00 8.293439740376607361e+00 5.788141526474975151e+00 5.717017114640454700e+00 3.456341064866929269e+00 5.788141526475181209e+00 4.336226603871120133e+00 3.665412689618554598e+00 2.371061919910765425e+00 5.717017114640424502e+00 3.665412689618534170e+00 6.470106631553696808e+00 4.316359791081090691e+00 3.456341064866932378e+00 2.371061919910762317e+00 4.316359791081088026e+00 3.150439192720097648e+00 7.244102014665476652e+00 4.954674957944495972e+00 5.515035849905879139e+00 3.408949038855442648e+00 4.954674957944695812e+00 3.665412689618554154e+00 3.451471154024023491e+00 2.284490630377118858e+00 5.515035849905850718e+00 3.451471154024004395e+00 6.899529361734568766e+00 4.686010168996893377e+00 3.408949038855445757e+00 2.284490630377114861e+00 4.686010168996891601e+00 3.456341061963454031e+00 4.658396331026994019e+00 3.197300671294213803e+00 3.639539647180052295e+00 2.284490630041605463e+00 3.197300671294337260e+00 2.371061919910766314e+00 2.284490630377119302e+00 1.531072148308791236e+00 3.639539647180034532e+00 2.284490630377107312e+00 4.658396327888459254e+00 3.197300668684237568e+00 2.284490630041607684e+00 1.531072148308789016e+00 3.197300668684236236e+00 2.371061917747996795e+00 1.156041325087437954e+01 7.786684374145433907e+00 9.000410925657664762e+00 5.515035848943356633e+00 7.786684374145795395e+00 5.717017114640425390e+00 5.515035849905850718e+00 3.639539647180034088e+00 9.000410925657611472e+00 5.515035849905816079e+00 1.156041324186107389e+01 7.786684366646798416e+00 5.515035848943361962e+00 3.639539647180026982e+00 7.786684366646793976e+00 5.717017108424160554e+00 7.244102014665429579e+00 4.954674957944467550e+00 5.515035849905844501e+00 3.408949038855423996e+00 4.954674957944666502e+00 3.665412689618534170e+00 3.451471154024003951e+00 2.284490630377107312e+00 5.515035849905815191e+00 3.451471154023984855e+00 6.899529361734523469e+00 4.686010168996867620e+00 3.408949038855427549e+00 2.284490630377103315e+00 4.686010168996864955e+00 3.456341061963435379e+00 1.346174795969929328e+01 8.897497310362629364e+00 1.156041324186113961e+01 7.244102008426491324e+00 8.897497310363084111e+00 6.470106631553696808e+00 6.899529361734566990e+00 4.658396327888458366e+00 1.156041324186107211e+01 6.899529361734523469e+00 1.635962686903488361e+01 1.119799861106987926e+01 7.244102008426501094e+00 4.658396327888447708e+00 1.119799861106987393e+01 8.293439727298437703e+00 8.897497307897767271e+00 5.919309415106647876e+00 7.786684366646837496e+00 4.954674953017852879e+00 5.919309415106927652e+00 4.316359791081089803e+00 4.686010168996894265e+00 3.197300668684237568e+00 7.786684366646796640e+00 4.686010168996868508e+00 1.119799861106988281e+01 7.760914566641799794e+00 4.954674953017859984e+00 3.197300668684231351e+00 7.760914566641796242e+00 5.788141517300060990e+00 6.899529365494874611e+00 4.686010172387339523e+00 5.515035848943391272e+00 3.451471152955657207e+00 4.686010172387536699e+00 3.456341064866932378e+00 3.408949038855446201e+00 2.284490630041608128e+00 5.515035848943361962e+00 3.408949038855427549e+00 7.244102008426500205e+00 4.954674953017859096e+00 3.451471152955661204e+00 2.284490630041604575e+00 4.954674953017857320e+00 3.665412685628688383e+00 4.658396331026986914e+00 3.197300671294208918e+00 3.639539647180045634e+00 2.284490630041601467e+00 3.197300671294331931e+00 2.371061919910762761e+00 2.284490630377115306e+00 1.531072148308789016e+00 3.639539647180026982e+00 2.284490630377103759e+00 4.658396327888448596e+00 3.197300668684231351e+00 2.284490630041604131e+00 1.531072148308786574e+00 3.197300668684230018e+00 2.371061917747992798e+00 8.897497307897763719e+00 5.919309415106645211e+00 7.786684366646834832e+00 4.954674953017851990e+00 5.919309415106924988e+00 4.316359791081088915e+00 4.686010168996892489e+00 3.197300668684236680e+00 7.786684366646793976e+00 4.686010168996865843e+00 1.119799861106987748e+01 7.760914566641796242e+00 4.954674953017858208e+00 3.197300668684230462e+00 7.760914566641792689e+00 5.788141517300058325e+00 6.470106628633406132e+00 4.316359790351772752e+00 5.717017108424187199e+00 3.665412685628683498e+00 4.316359790351969039e+00 3.150439192720097203e+00 3.456341061963453587e+00 2.371061917747996350e+00 5.717017108424157890e+00 3.456341061963434491e+00 8.293439727298435926e+00 5.788141517300059213e+00 3.665412685628687495e+00 2.371061917747991910e+00 5.788141517300056549e+00 4.336226596873829386e+00', sep=' ', dtype=float).reshape(16,16)

equal(abs(V_pp-V_pp_ref).max(), 0.0, 1.0e-10)
